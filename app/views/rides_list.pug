extends layout

block content
  .container.py-4
    if user
      // My Offered Rides Section
      .mb-5
        h2.mb-4 
          i.fas.fa-car.me-2
          | My Offered Rides
        if myOfferedRides && myOfferedRides.length > 0
          .row
            each ride in myOfferedRides
              .col-lg-6.mb-4
                .card.h-100.shadow-sm
                  .card-header.bg-white.d-flex.justify-content-between.align-items-center.py-3
                    .d-flex.align-items-center
                      img.rounded-circle.me-2(src=getProfilePhoto(ride.profile_photo) alt=`${ride.driver_name}'s profile photo` width='40' height='40')
                      .d-flex.flex-column
                        h5.mb-0 #{ride.driver_name}
                        small.text-muted Driver
                    - var departureDate = new Date(ride.departure_time)
                    span.badge.bg-primary.fs-6 #{departureDate.toLocaleString()}
                  .card-body
                    .row.g-3
                      .col-md-8
                        .d-flex.align-items-center.mb-2
                          i.fas.fa-map-marker-alt.text-danger.me-2
                          h5.mb-0 From: #{ride.pickup_location}
                        .d-flex.align-items-center.mb-2
                          i.fas.fa-flag-checkered.text-success.me-2
                          h5.mb-0 To: #{ride.dropoff_location}
                        .d-flex.align-items-center.mb-2
                          i.fas.fa-clock.text-primary.me-2
                          small Departure: #{departureDate.toLocaleTimeString()}
                        if ride.tags
                          .d-flex.flex-wrap.gap-1.mt-2
                            each tag in (ride.tags || '').split(',')
                              if tag.trim()
                                a.badge.bg-light.text-dark.text-decoration-none(href=`/rides?tag=${encodeURIComponent(tag.trim())}`)= tag.trim()
                      .col-md-4.text-end
                        .d-flex.flex-column.justify-content-between.h-100
                          .mb-3
                            span.badge.bg-success.fs-6
                              i.fas.fa-chair.me-1
                              | #{ride.seats_available} seats left
                          .d-flex.gap-2
                            a.btn.btn-primary.flex-grow-1(href=`/rides/${ride.id}`)
                              i.fas.fa-info-circle.me-2
                              | View Details
                            button.btn.btn-danger.delete-ride(data-ride-id=ride.id)
                              i.fas.fa-trash
        else
          .alert.alert-info
            i.fas.fa-info-circle.me-2
            | You haven't offered any rides yet.

      // My Booked Rides Section
      .mb-5
        h2.mb-4
          i.fas.fa-ticket-alt.me-2
          | My Booked Rides
        if myBookedRides && myBookedRides.length > 0
          .row
            each ride in myBookedRides
              .col-lg-6.mb-4
                .card.h-100.shadow-sm
                  .card-header.bg-white.d-flex.justify-content-between.align-items-center.py-3
                    .d-flex.align-items-center
                      img.rounded-circle.me-2(src=getProfilePhoto(ride.profile_photo) alt=`${ride.driver_name}'s profile photo` width='40' height='40')
                      .d-flex.flex-column
                        h5.mb-0 #{ride.driver_name}
                        small.text-muted Driver
                    - var departureDate = new Date(ride.departure_time)
                    span.badge.bg-primary.fs-6 #{departureDate.toLocaleString()}
                  .card-body
                    .row.g-3
                      .col-md-8
                        .d-flex.align-items-center.mb-2
                          i.fas.fa-map-marker-alt.text-danger.me-2
                          h5.mb-0 From: #{ride.pickup_location}
                        .d-flex.align-items-center.mb-2
                          i.fas.fa-flag-checkered.text-success.me-2
                          h5.mb-0 To: #{ride.dropoff_location}
                        .d-flex.align-items-center.mb-2
                          i.fas.fa-clock.text-primary.me-2
                          small Departure: #{departureDate.toLocaleTimeString()}
                        if ride.tags
                          .d-flex.flex-wrap.gap-1.mt-2
                            each tag in (ride.tags || '').split(',')
                              if tag.trim()
                                a.badge.bg-light.text-dark.text-decoration-none(href=`/rides?tag=${encodeURIComponent(tag.trim())}`)= tag.trim()
                      .col-md-4.text-end
                        .d-flex.flex-column.justify-content-between.h-100
                          .mb-3
                            span.badge.bg-info.fs-6
                              i.fas.fa-check-circle.me-1
                              | Booked
                          a.btn.btn-primary.w-100(href=`/rides/${ride.id}`)
                            i.fas.fa-info-circle.me-2
                            | View Details
        else
          .alert.alert-info
            i.fas.fa-info-circle.me-2
            | You haven't booked any rides yet.

    // Available Rides Section
    .d-flex.justify-content-between.align-items-center.mb-4
      h1.display-4 Available Rides
      a.btn.btn-primary(href='/rides/new')
        i.fas.fa-plus.me-2
        | Offer a Ride
    
    .row.mb-4
      .col-md-8
        form(action='/rides', method='GET').d-flex.gap-2
          .input-group
            span.input-group-text
              i.fas.fa-search
            input.form-control(type='text', name='search', placeholder='Search by location or destination', value=search || '')
            if tag
              input(type='hidden', name='tag', value=tag)
            button.btn.btn-primary(type='submit')
              i.fas.fa-search.me-2
              | Search
            if search
              a.btn.btn-outline-secondary(href=`/rides${tag ? '?tag=' + tag : ''}`)
                i.fas.fa-times
      .col-md-4
        .d-flex.justify-content-end.gap-2
          if tags && tags.length > 0
            select.form-select.w-auto(id='tagFilter')
              option(value='') All Categories
              each tagOption in tags
                option(value=tagOption, selected=tag === tagOption)= tagOption
          if tag
            a.btn.btn-outline-secondary(href=`/rides${search ? '?search=' + search : ''}`)
              i.fas.fa-times.me-2
              | Clear Filter
    
    .row
      each ride in rides
        .col-lg-6.mb-4
          .card.h-100.shadow-sm
            .card-header.bg-white.d-flex.justify-content-between.align-items-center.py-3
              .d-flex.align-items-center
                img.rounded-circle.me-2(src=getProfilePhoto(ride.profile_photo) alt=`${ride.driver_name}'s profile photo` width='40' height='40')
                .d-flex.flex-column
                  h5.mb-0 #{ride.driver_name}
                  small.text-muted Driver
              - var departureDate = new Date(ride.departure_time)
              span.badge.bg-primary.fs-6 #{departureDate.toLocaleString()}
            .card-body
              .row.g-3
                .col-md-8
                  .d-flex.align-items-center.mb-2
                    i.fas.fa-map-marker-alt.text-danger.me-2
                    h5.mb-0 From: #{ride.pickup_location}
                  .d-flex.align-items-center.mb-2
                    i.fas.fa-flag-checkered.text-success.me-2
                    h5.mb-0 To: #{ride.dropoff_location}
                  .d-flex.align-items-center.mb-2
                    i.fas.fa-clock.text-primary.me-2
                    small Departure: #{departureDate.toLocaleTimeString()}
                  if ride.tags
                    .d-flex.flex-wrap.gap-1.mt-2
                      each tag in (ride.tags || '').split(',')
                        if tag.trim()
                          a.badge.bg-light.text-dark.text-decoration-none(href=`/rides?tag=${encodeURIComponent(tag.trim())}`)= tag.trim()
                .col-md-4.text-end
                  .d-flex.flex-column.justify-content-between.h-100
                    .mb-3
                      span.badge.bg-success.fs-6
                        i.fas.fa-chair.me-1
                        | #{ride.seats_available} seats left
                    a.btn.btn-primary.w-100(href=`/rides/${ride.id}`)
                      i.fas.fa-info-circle.me-2
                      | View Details
      else
        .col-12
          .alert.alert-info.d-flex.align-items-center
            i.fas.fa-info-circle.me-2
            | No rides found matching your criteria.
    
    if totalPages > 1
      nav.mt-4(aria-label='Page navigation')
        ul.pagination.justify-content-center
          li.page-item(class=currentPage <= 1 ? 'disabled' : '')
            a.page-link(href=`/rides?page=${currentPage - 1}${search ? '&search=' + search : ''}${tag ? '&tag=' + tag : ''}`)
              i.fas.fa-chevron-left.me-1
              | Previous
          
          - for (let i = 1; i <= totalPages; i++)
            li.page-item(class=i === currentPage ? 'active' : '')
              a.page-link(href=`/rides?page=${i}${search ? '&search=' + search : ''}${tag ? '&tag=' + tag : ''}`)= i
          
          li.page-item(class=currentPage >= totalPages ? 'disabled' : '')
            a.page-link(href=`/rides?page=${currentPage + 1}${search ? '&search=' + search : ''}${tag ? '&tag=' + tag : ''}`)
              | Next
              i.fas.fa-chevron-right.ms-1

block scripts
  script.
    document.getElementById('tagFilter').addEventListener('change', function() {
      const tag = this.value;
      const search = new URLSearchParams(window.location.search).get('search') || '';
      
      if (tag) {
        window.location.href = `/rides?tag=${encodeURIComponent(tag)}${search ? '&search=' + encodeURIComponent(search) : ''}`;
      } else {
        window.location.href = `/rides${search ? '?search=' + encodeURIComponent(search) : ''}`;
      }
    });
    
    // Add event listener for search form submission
    document.querySelector('form').addEventListener('submit', function(e) {
      const searchInput = this.querySelector('input[name="search"]');
      if (!searchInput.value.trim()) {
        e.preventDefault();
        alert('Please enter a search term');
      }
    });
    
    // Add event listeners for delete ride buttons
    document.querySelectorAll('.delete-ride').forEach(button => {
      button.addEventListener('click', function() {
        const rideId = this.getAttribute('data-ride-id');
        if (confirm('Are you sure you want to delete this ride? This action cannot be undone.')) {
          fetch(`/rides/${rideId}/delete`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          })
          .then(response => {
            if (response.ok) {
              window.location.reload();
            } else {
              return response.text().then(text => {
                throw new Error(text || 'Failed to delete ride');
              });
            }
          })
          .catch(error => {
            alert(error.message);
          });
        }
      });
    }); 